<ion-content class="home-bg" fullscreen>
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      pullingText="Pull to refresh"
      refreshingSpinner="circles"
      refreshingText="Refreshing...">
    </ion-refresher-content>
  </ion-refresher>

  <div class="home-header">
    <div class="avatar">
      <img [src]="user?.photoURL || 'assets/avatar.png'" alt="Avatar" />
    </div>
    <div>
      <div class="subtitle">Welcome back,</div>
      <div class="header-username">{{ user?.userName || user?.displayName || 'User' }}</div>
      <div class="header-tagline">Ready to make a difference today?</div>
    </div>
    <div class="notification-icon-container">
      <ion-icon name="notifications-outline" class="notif-icon" (click)="goToNotifications()"></ion-icon>
      <ion-badge *ngIf="unreadNotificationCount > 0" color="danger" class="notification-badge">
        {{ unreadNotificationCount }}
      </ion-badge>
    </div>
  </div>

  <div class="featured-missions-title">Featured Missions</div>
  <div class="featured-missions-scroll">
    <div class="mission-card" *ngFor="let mission of featuredMissions" [ngClass]="{'open': mission.status?.toLowerCase() === 'open'}" (click)="goToMissionDetail(mission.id)">
      <div class="mission-type">{{ mission.missionName }}</div>
      <div class="mission-details">üìç{{ formatLocation(mission.location) }}</div>
      <div class="mission-details">
        <ion-icon name="calendar-outline"></ion-icon>
        {{ mission.date | date:'MMMM d, y' }}
      </div>
      <div class="mission-details">
        <ion-icon name="time-outline"></ion-icon>
        {{ formatTimeTo12Hour(mission.start_time || mission.startTime) }} - {{ formatTimeTo12Hour(mission.end_time || mission.endTime) }}
      </div>
      <div class="mission-details">üë• Volunteers needed: {{ mission.volunteers }}</div>
      <div class="mission-details">{{ mission.distance }}</div>
      <div class="mission-actions">
        <ion-button size="small" 
                    [color]="getButtonColor(mission)" 
                    [disabled]="!canJoinMission(mission)"
                    (click)="handleMissionAction(mission, $event)">
          {{ getButtonText(mission) }}
        </ion-button>
      </div>
    </div>
  </div>

  <ion-grid class="quick-actions-cards">
    <ion-row>
      <ion-col size="4">
        <div class="action-card" (click)="goToJoinMission()">
          <img src="assets/icons/join-mission.png" alt="Join Mission" />
          <div class="label">JOIN MISSION</div>
        </div>
      </ion-col>
      <ion-col size="4">
        <div class="action-card" (click)="goToDonate()">
          <img src="assets/icons/donate.png" alt="Donate" />
          <div class="label">DONATE</div>
        </div>
      </ion-col>
      <ion-col size="4">
        <div class="action-card" (click)="goToLeaderboard()">
          <img src="assets/icons/leaderboard.png" alt="Leaderboard" />
          <div class="label">LEADERBOARD</div>
        </div>
      </ion-col>
    </ion-row>
  </ion-grid>

  <div class="ongoing-title">Ongoing Missions near you</div>
  <div class="map-container">
    <div id="map" aria-label="Map of ongoing missions"></div>
    <div id="map-error" class="map-error">
      <ion-icon name="warning-outline"></ion-icon>
      <p>Map temporarily unavailable</p>
      <ion-button size="small" (click)="retryMapLoad()">Retry</ion-button>
    </div>
    <button class="locate-btn" (click)="recenterMap()" title="Recenter map">
      <ion-icon name="locate"></ion-icon>
    </button>
  </div>
</ion-content>