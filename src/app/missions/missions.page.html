<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Missions</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="openFilters()" fill="clear">
        <ion-icon name="options-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">


  <!-- Search and Filter Bar -->
  <div class="search-filter-container">
    <div class="search-wrapper">
      <ion-searchbar 
        placeholder="Search missions..." 
        (ionInput)="onSearchChange($event.detail.value)"
        class="custom-searchbar">
      </ion-searchbar>
    </div>
    <div class="filter-chips">
      <ion-chip 
        *ngFor="let service of servicesOptions" 
        [color]="selectedServices.includes(service) ? 'primary' : 'medium'"
        (click)="toggleServiceFilter(service)"
        class="service-chip">
        <ion-icon [name]="getServiceIcon(service)"></ion-icon>
        <ion-label>{{ service }}</ion-label>
      </ion-chip>
    </div>
  </div>

  <!-- Campaign Count -->
  <div class="ion-padding">
    <p class="campaign-count">
      WE HAVE TOTAL <b>{{ missions.length }} UPCOMING CAMPAIGNS</b>
    </p>
  </div>

  <!-- Mission Cards -->
  <div class="missions-container" *ngIf="filtered.length; else empty">
    <div class="mission-card" 
         *ngFor="let m of filtered; trackBy: trackById" 
         [ngClass]="{'mission-closed': m.status?.toLowerCase() !== 'open'}"
         (click)="goToMissionDetail(m.id)">
      
      <!-- Mission Header -->
      <div class="mission-header">
        <div class="mission-status-badge" [ngClass]="getStatusClass(m)">
          <ion-icon [name]="getStatusIcon(m)"></ion-icon>
          <span>{{ getStatusText(m) }}</span>
        </div>
        <div class="mission-date">
          <ion-icon name="calendar-outline"></ion-icon>
          <span>{{ m.date | date:'MMMM d, y' }}</span>
        </div>
      </div>

      <!-- Mission Content -->
      <div class="mission-content">
        <h3 class="mission-title">{{ m.missionName }}</h3>
        <p class="mission-description">{{ m.description || m.tagline || 'Join us in making a difference in our community' }}</p>
        
        <div class="mission-details">
          <div class="detail-item">
            <ion-icon name="location-outline"></ion-icon>
            <span>{{ formatLocation(m.location) }}</span>
          </div>
          <div class="detail-item">
            <ion-icon name="time-outline"></ion-icon>
            <span>{{ formatTimeTo12Hour(m.startTime) }} - {{ formatTimeTo12Hour(m.endTime) }}</span>
          </div>
          <div class="detail-item">
            <ion-icon name="people-outline"></ion-icon>
            <span>{{ m.volunteers }} volunteers needed</span>
          </div>
        </div>

        <!-- Services Tags -->
        <div class="services-tags" *ngIf="m.services && m.services.length">
          <ion-chip *ngFor="let service of m.services" size="small" color="light">
            <ion-icon [name]="getServiceIcon(service)"></ion-icon>
            <ion-label>{{ service }}</ion-label>
          </ion-chip>
        </div>

        <!-- Organization Info -->
        <div class="organization-info">
          <div class="org-avatar">
            <img [src]="getOrganization(m.orgId)?.profilePictureURL" 
                 alt="Organization Avatar" 
                 *ngIf="getOrganization(m.orgId)?.profilePictureURL"
                 class="org-profile-img">
            <ion-icon name="business-outline" 
                      *ngIf="!getOrganization(m.orgId)?.profilePictureURL"></ion-icon>
          </div>
          <div class="org-details">
            <span class="org-name">{{ m.orgName }}</span>
            <span class="org-type">Organization</span>
          </div>
        </div>
      </div>

      <!-- Mission Actions -->
      <div class="mission-actions" (click)="$event.stopPropagation()">
        <ion-button 
          expand="block" 
          [color]="getButtonColor(m)" 
          [disabled]="!canJoinMission(m)"
          (click)="handleMissionAction(m, $event)"
          class="action-button">
          <ion-icon [name]="getActionIcon(m)"></ion-icon>
          <span>{{ getButtonText(m) }}</span>
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <ng-template #empty>
    <div class="empty-state">
      <div class="empty-icon">
        <ion-icon name="search-outline"></ion-icon>
      </div>
      <h3>No missions found</h3>
      <p>Try adjusting your search criteria or check back later for new opportunities.</p>
      <ion-button fill="outline" (click)="clearFilters()">
        <ion-icon name="refresh-outline"></ion-icon>
        <span>Clear Filters</span>
      </ion-button>
    </div>
  </ng-template>

  <!-- Advanced Filters Modal -->
  <ion-modal [isOpen]="filtersOpen" (didDismiss)="closeFilters()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Filter Missions</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeFilters()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <!-- Sort Options -->
        <div class="filter-section">
          <h3>Sort by</h3>
          <ion-segment [(ngModel)]="sortOrder" class="sort-segment">
            <ion-segment-button value="desc">
              <ion-icon name="arrow-down-outline"></ion-icon>
              <ion-label>Newest First</ion-label>
            </ion-segment-button>
            <ion-segment-button value="asc">
              <ion-icon name="arrow-up-outline"></ion-icon>
              <ion-label>Oldest First</ion-label>
            </ion-segment-button>
          </ion-segment>
        </div>

        <!-- Service Filters -->
        <div class="filter-section">
          <h3>Services</h3>
          <div class="service-filters">
            <ion-item *ngFor="let service of servicesOptions" button>
              <ion-checkbox 
                slot="start" 
                [checked]="selectedServices.includes(service)" 
                (ionChange)="onToggleService(service, $event.detail.checked)">
              </ion-checkbox>
              <ion-icon [name]="getServiceIcon(service)" slot="start"></ion-icon>
              <ion-label>{{ service }}</ion-label>
            </ion-item>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="filter-actions">
          <ion-button expand="block" (click)="applyFilters(); closeFilters()">
            <ion-icon name="checkmark-outline"></ion-icon>
            <span>Apply Filters</span>
          </ion-button>
          <ion-button expand="block" fill="outline" (click)="clearFilters()">
            <ion-icon name="refresh-outline"></ion-icon>
            <span>Clear All</span>
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
